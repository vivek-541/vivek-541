# .github/workflows/dependency-bot.yml
name: Advanced Dependency Bot

on:
  schedule:
    # Run every Monday and Thursday at 9 AM UTC
    - cron: '0 9 * * 1,4'
  workflow_dispatch:
    inputs:
      strategy:
        description: 'Update strategy'
        required: true
        default: 'minor'
        type: choice
        options:
          - minor
          - security
          - all

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ¤– Run Dependency Bot
        id: bot
        run: |
          node scripts/dependency-bot.js
          echo "has_updates=$?" >> $GITHUB_OUTPUT
      
      - name: ğŸ“Š Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: update-report.md
      
      - name: ğŸ”€ Create Pull Request
        if: steps.bot.outputs.has_updates == '0'
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(deps): update dependencies
            
            - Updated outdated packages
            - Fixed security vulnerabilities
            
            Auto-generated by Dependency Bot
          branch: bot/dependency-updates-${{ github.run_number }}
          delete-branch: true
          title: 'ğŸ¤– [Dependency Bot] Package Updates'
          body-path: update-report.md
          labels: |
            dependencies
            automated
            bot
          assignees: ${{ github.repository_owner }}
          draft: false
      
      - name: ğŸ·ï¸ Add labels to PR
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('update-report.md', 'utf8');
            
            // Check for security vulnerabilities
            if (report.includes('Security Vulnerabilities')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.create-pr.outputs.pull-request-number }},
                labels: ['security', 'critical']
              });
            }
            
            // Check for major updates
            if (report.includes('Breaking changes possible')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.create-pr.outputs.pull-request-number }},
                labels: ['breaking-change']
              });
            }
      
      - name: ğŸ’¬ Comment on PR
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## ğŸ¤– Dependency Bot Summary
            
            This PR contains automated dependency updates. Please review the changes carefully.
            
            ### âš¡ Quick Actions
            - Review the dependency report above
            - Check for breaking changes in major version updates
            - Ensure all tests pass
            - Merge when ready
            
            ### ğŸ”„ To Update Strategy
            Run the workflow manually with different strategy:
            - \`minor\`: Safe updates within semver range
            - \`security\`: Only security fixes
            - \`all\`: Update to latest versions (may include breaking changes)
            
            ---
            *Automated by [Dependency Bot](https://github.com/${context.repo.owner}/${context.repo.repo})*
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-pr.outputs.pull-request-number }},
              body: comment
            });
      
      - name: âœ… Notification
        if: steps.create-pr.outputs.pull-request-number
        run: |
          echo "âœ… PR created: ${{ steps.create-pr.outputs.pull-request-url }}"
          echo "ğŸ“Š Review the dependency report in the PR description"
      
      - name: ğŸ‰ No updates needed
        if: steps.bot.outputs.has_updates != '0'
        run: |
          echo "âœ¨ All dependencies are up to date!"