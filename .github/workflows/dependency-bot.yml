name: Advanced Dependency Bot

on:
  schedule:
    - cron: '0 9 * * 1,4'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ðŸ“¦ Install dependencies
        run: npm ci
      
      - name: ï¿½ï¿½ Run Dependency Bot
        id: bot
        run: |
          node scripts/dependency-bot.js || echo "has_updates=false" >> $GITHUB_OUTPUT
          if [ $? -eq 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: ðŸ“Š Upload report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: update-report.md
      
      - name: ðŸ”€ Create Pull Request
        if: steps.bot.outputs.has_updates == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(deps): update dependencies
            
            - Updated outdated packages
            - Fixed security vulnerabilities
            
            Auto-generated by Dependency Bot
          branch: bot/dependency-updates-${{ github.run_number }}
          delete-branch: true
          title: 'ðŸ¤– [Dependency Bot] Package Updates'
          body-path: update-report.md
          labels: |
            dependencies
            automated
            bot
          assignees: ${{ github.repository_owner }}
          draft: false
      
      - name: âœ… Notification
        if: steps.create-pr.outputs.pull-request-number
        run: |
          echo "âœ… PR created: ${{ steps.create-pr.outputs.pull-request-url }}"
      
      - name: ðŸŽ‰ No updates needed
        if: steps.bot.outputs.has_updates != 'true'
        run: |
          echo "âœ¨ All dependencies are up to date!"
